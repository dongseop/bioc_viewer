<%-
ranges = [p.offset]
max = p.offset + if ptext.nil? then 0 else ptext.size end
p.annotations.each do |a|
  a.locations.each do |l|
    n_pos = l.offset.to_i + l.length.to_i 
    ranges << l.offset.to_i
    ranges << n_pos if n_pos < max
  end
end
ranges = ranges.uniq.sort

ranges.each_with_index do |s_pos, index|
  if index < ranges.size - 1
    e_pos = ranges[index + 1]
  else 
    e_pos = max
  end

  ids = []
  p.annotations.each do |a|
    a.locations.each do |l|
      ss = l.offset.to_i
      ee = l.offset.to_i + l.length.to_i
      if !(ee <= s_pos || e_pos <= ss)
        ids << a.id
      end
    end
  end
  ids = ids.uniq.sort

  # cls = ids.map{|i| "#{i.split("_")[0]}"}.uniq
  # cls2 = ids.map{|i| "#{i[0]}"}.uniq
  # if cls.blank?
#   cls = []
  # else 
  #   cls = cls + cls2
  #   cls << "annotation"
  # end

  type2color = {
    "gene" => "yellow",
    "organism" => "green",
    "experimentalmethod" => "grey",
    "geneticinteractiontype" => "red",
    "gievidence" => "red",
    "gimention" => "red",
    "ppievidence" => "blue",
    "ppimention" => "blue"
  }
  cls = []
  gene_id = ""
  gene_name = ""
  content = ids.map do |id| 
    a = p.annotations.select{|a| a.id == id}[0]
    
    type = a.infons['type']
    cls_name = @document.get_class_from_annotation(a)

    ret = []
    ret << "<div class='item popup-item #{cls_name}'>"
    ret << "<strong class='annotation-id'>#{id}</strong>"
    cls << cls_name
    unless type.nil?
      ret << "<span class='ui label mini #{type2color[type.downcase]}'>#{type}</span>"
      case type.downcase
      when 'gene'
        gene_id = a.infons['GeneID']
        gene_name = a.text
        ret << "<a href='http://www.ncbi.nlm.nih.gov/gene?term=#{gene_id}' target='_blank'><i class='icon globe'></i>#{gene_id}</a>"
      when 'organism'
        tid = a.infons['OrganismID']
        ret << "<a href='http://www.ncbi.nlm.nih.gov/taxonomy/?term=#{tid}' target='_blank'><i class='icon globe'></i>#{tid}</a>"
      end
    end
    ret << "</div>"
    ret.join()
  end

  cls = cls.uniq
  cls << "annotation" unless cls.blank?

  -%><span data-gene="<%=gene_id%>" data-name="<%=gene_name%>" class="<%=cls.join(" ") %>"><%=ptext[s_pos - p.offset, e_pos - s_pos]%></span><%- unless cls.blank? -%><div class="ui popup" style="display:none"><%=content.join.html_safe%></div><%-end 
  end -%>
